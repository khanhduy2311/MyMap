extends ../views/layouts/default.pug

block styles
  link(rel="stylesheet", href="/css/style-dashboard.css")

block main
  .dashboard-layout
    aside.dashboard-sidebar
      //- Sidebar chỉ nên chứa menu điều hướng
      nav.sidebar-nav
        ul
          li
            a.active(href="/dashboard", title="Danh sách Mindmap")
              i.fas.fa-folder-open
              span Danh sách
          li
            a(href="/dashboard/trash", title="Thùng rác")
              i.fas.fa-trash
              span Thùng rác

    main.dashboard-content
      h2.content-title Tất cả dự án
      #mindmapGrid.mindmap-grid
        if mindmaps && mindmaps.length > 0
          each mindmap in mindmaps
            .mindmap-card(data-id=`${mindmap._id}`)
              a.card-link(href=`/mindmaps/${mindmap._id}`)
                .preview-image
              
              .card-title.card-title-display
                a(href=`/mindmaps/${mindmap._id}`) #{mindmap.title}
              
              .card-title.card-title-edit(style="display: none;")
                form.inline-edit-form
                  input(type="text", value=mindmap.title, class="inline-edit-input")
              
              .card-actions
                button.btn-action.btn-edit(type="button", title="Chỉnh sửa tên")
                  i.fas.fa-pencil-alt
                button.btn-action.btn-delete(type="button", data-id=`${mindmap._id}`, title="Xóa mindmap")
                  i.fas.fa-trash-alt
        else
          .alert.alert-info.text-center.p-5
            h4.alert-heading Chưa có mindmap nào!
            p.mb-0 Hãy bắt đầu sáng tạo bằng cách nhấn vào nút dấu cộng.

  //- Nút tạo mới phải nằm ở đây, bên ngoài .dashboard-layout để có position: fixed
  .create-new-container
    //- Các tùy chọn con
    .fab-options
      svg.fab-lines(width="40" height="60" viewbox="0 0 40 60")
        path(d="M 5 30 Q 20 30 35 15")
        path(d="M 5 30 Q 20 30 35 45")
      .fab-options-list
        a.fab-option-item(href="#")
          span Tạo mindmap trống
        a.fab-option-item(href="/upload/page")
          span Upload tài liệu

    //- Nút bấm chính
    button.main-fab-btn(type="button")
      i.fas.fa-plus
  
block scripts
  script.
    document.addEventListener('DOMContentLoaded', () => {
      const mindmapGrid = document.getElementById('mindmapGrid');

      mindmapGrid.addEventListener('click', (event) => {
        const target = event.target;
        const mindmapCard = target.closest('.mindmap-card');
        if (!mindmapCard) return;

        if (target.closest('.btn-delete')) {
          const mindmapId = mindmapCard.dataset.id;
          if (confirm('Bạn có chắc chắn muốn xóa mindmap này không?')) {
            fetch(`/mindmaps/${mindmapId}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                mindmapCard.remove();
              } else {
                alert('Lỗi: ' + data.message);
              }
            })
            .catch(err => alert('Lỗi kết nối.'));
          }
        } else if (target.closest('.btn-edit')) {
          mindmapCard.classList.add('is-editing');
          const displayView = mindmapCard.querySelector('.card-title-display');
          const editView = mindmapCard.querySelector('.card-title-edit');
          const input = editView.querySelector('input');
  
          displayView.style.display = 'none';
          editView.style.display = 'block';
          input.focus();
          input.select();
        } 
        //- ĐÃ XÓA LOGIC XỬ LÝ NÚT HỦY
      });

      // Xử lý submit form edit (vẫn hoạt động khi nhấn Enter)
      mindmapGrid.addEventListener('submit', async (event) => {
        if (!event.target.classList.contains('inline-edit-form')) return;
        
        event.preventDefault();
        const form = event.target;
        const mindmapCard = form.closest('.mindmap-card');
        const mindmapId = mindmapCard.dataset.id;
        const input = form.querySelector('input');
        const newTitle = input.value.trim();

        try {
          const res = await fetch(`/mindmaps/${mindmapId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: newTitle })
          });
          const data = await res.json();
          
          if (data.success) {
            const displayView = mindmapCard.querySelector('.card-title-display');
            const editView = mindmapCard.querySelector('.card-title-edit');
            
            displayView.querySelector('a').textContent = data.newTitle;
            editView.style.display = 'none';
            displayView.style.display = 'block';
            mindmapCard.classList.remove('is-editing');
          } else {
            alert('Lỗi: ' + data.message);
            mindmapCard.classList.remove('is-editing');
          }
        } catch (err) {
          alert('Lỗi kết nối.');
        }
      });
    });

