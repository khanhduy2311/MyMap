extends ../views/layouts/default.pug

block main
  .container.mt-4.fade-in-up
    //- Header trang
    .d-flex.justify-content-between.align-items-center.mb-4
      h1.text-primary
        i.fas.fa-th-large.me-2
        | Mindmap của bạn
    
    //- Nút "Tạo Mindmap mới"
    a.btn.btn-primary.btn-lg(href="/upload/page")
      i.fas.fa-plus.me-2
      | Tạo Mindmap mới

    //- Danh sách Mindmap
    if mindmaps && mindmaps.length > 0
      .list-group
        //- Lặp qua từng mindmap
        each mindmap in mindmaps
          //- SỬA TỪ 'a' (link) THÀNH 'div' (container)
          .list-group-item.list-group-item-action.d-flex.justify-content-between.align-items-center
            
            //- TIÊU ĐỀ (BÂY GIỜ LÀ LINK)
            a.text-decoration-none.text-dark.flex-grow-1.me-3(href=`/mindmaps/${mindmap._id}`)
              span
                i.fas.fa-diagram-project.me-2
                | #{mindmap.title}
            
            //- KHU VỰC CHO NGÀY VÀ NÚT XÓA
            .d-flex.align-items-center
              //- Ngày tạo
              small.text-muted.me-3 #{mindmap.createdAt ? new Date(mindmap.createdAt).toLocaleDateString('vi-VN') : ''}
              
              //- NÚT XÓA MỚI
              button.btn.btn-outline-danger.btn-sm.btn-delete(type="button" data-id=`${mindmap._id}` title="Xóa mindmap")
                i.fas.fa-trash-alt

    //- Trạng thái trống (nếu không có mindmap)
    else
      .alert.alert-info.text-center.p-5
        h4.alert-heading Chưa có mindmap nào!
        p.mb-4 Hãy bắt đầu sáng tạo bằng cách tạo ra mindmap đầu tiên của bạn.

//- THÊM JAVASCRIPT XỬ LÝ XÓA VÀO CUỐI FILE
block scripts
  script.
    document.addEventListener('DOMContentLoaded', () => {
      // 1. Tìm tất cả các nút xóa
      const deleteButtons = document.querySelectorAll('.btn-delete');
      
      deleteButtons.forEach(button => {
        // 2. Gán sự kiện click cho từng nút
        button.addEventListener('click', (event) => {
          event.preventDefault();
          event.stopPropagation(); // Ngăn sự kiện click nổi bọt

          const mindmapId = event.target.closest('button').dataset.id;
          const mindmapItem = event.target.closest('.list-group-item');

          // 3. Hiển thị xác nhận
          if (confirm('Bạn có chắc chắn muốn xóa mindmap này không?')) {
            // 4. Gửi yêu cầu DELETE đến server
            fetch(`/mindmaps/${mindmapId}`, { // URL này khớp với route backend
              method: 'DELETE',
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                // 5. Nếu thành công, xóa mục đó khỏi giao diện
                mindmapItem.remove();
              } else {
                alert('Lỗi: ' + (data.message || 'Không thể xóa'));
              }
            })
            .catch(err => {
              console.error('Fetch error:', err);
              alert('Đã xảy ra lỗi khi kết nối đến server.');
            });
          }
        });
      });
    });