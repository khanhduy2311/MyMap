extends ../views/layouts/default.pug

block main
  .container.mt-4
    .d-flex.justify-content-between.align-items-center.mb-4
      h1 Chào mừng, #{user.name}!
      a(href="/mindmaps/create", class="btn btn-primary btn-lg") + Tạo Mindmap mới

    //- HỆ THỐNG TABS ĐIỀU HƯỚNG
    ul.nav.nav-tabs(id="myTab", role="tablist")
      li.nav-item(role="presentation")
        button.nav-link.active(id="profile-tab", data-bs-toggle="tab", data-bs-target="#profile", type="button", role="tab") Thông tin cá nhân
      li.nav-item(role="presentation")
        button.nav-link(id="mindmaps-tab", data-bs-toggle="tab", data-bs-target="#mindmaps", type="button", role="tab") Mindmap của tôi
      li.nav-item(role="presentation")
        button.nav-link(id="avatar-tab", data-bs-toggle="tab", data-bs-target="#avatar-upload", type="button", role="tab") Thay đổi Avatar
      li.nav-item(role="presentation")
        button.nav-link(id="document-tab", data-bs-toggle="tab", data-bs-target="#document-upload", type="button", role="tab") Upload Tài Liệu

    //- ====================== NỘI DUNG CÁC TAB ======================
    .tab-content#myTabContent

      //- === TAB 1: THÔNG TIN CÁ NHÂN ===
      #profile.tab-pane.fade.show.active(role="tabpanel")
        .card.border-top-0
          .card-body.p-4
            .row.align-items-center
              .col-md-3.text-center
                img(src=user.avatar || "/img/default-avatar.png", alt="Avatar", class="img-fluid rounded-circle", style="width: 120px; height: 120px; object-fit: cover;")
              .col-md-9
                h3 #{user.name}
                p.text-muted @#{user.username}
                a(href="/profile/edit", class="btn btn-outline-primary btn-sm") Chỉnh sửa thông tin

      //- === TAB 2: DANH SÁCH MINDMAP ===
      #mindmaps.tab-pane.fade(role="tabpanel")
        .card.border-top-0
          .card-body
            if mindmaps && mindmaps.length > 0
              .list-group
                each mindmap in mindmaps
                  a(href=`/mindmaps/${mindmap._id}`, class="list-group-item list-group-item-action")= mindmap.title
            else
              .alert.alert-info Chưa có mindmap nào.

      //- === TAB 3: THAY ĐỔI AVATAR ===
      #avatar-upload.tab-pane.fade(role="tabpanel")
        .card.border-top-0
          .card-body.p-4
            h4.mb-3 Tải lên ảnh đại diện mới
            p.text-muted Chỉ chấp nhận file ảnh (.jpg, .png, .gif)
            hr

            form(action="/upload/avatar" method="POST" enctype="multipart/form-data")
              .mb-3.text-center
                img(
                  src=user.avatar || "/img/default-avatar.png",
                  alt="Ảnh xem trước",
                  class="img-thumbnail d-block mx-auto mb-3",
                  id="avatarPreview",
                  style="max-width: 200px; max-height: 200px; object-fit: cover; border-radius: 10px;"
                )
                input#avatarInput(type="file" name="avatar" accept="image/*" class="d-none")
                button.btn.btn-outline-secondary(type="button", onclick="document.getElementById('avatarInput').click()")
                  i.fas.fa-upload.me-2
                  | Chọn ảnh mới...
                .form-text.mt-2#fileNameAvatar.text-muted Chưa có file nào được chọn.
              
              button.btn.btn-primary.w-100.mt-3(type="submit") Cập nhật Ảnh đại diện

      //- === TAB 4: UPLOAD TÀI LIỆU ===
      #document-upload.tab-pane.fade(role="tabpanel")
        .card.border-top-0
          .card-body.p-4
            h4.mb-3 Tải lên tài liệu của bạn
            p.text-muted Chỉ chấp nhận file .pdf hoặc .docx
            hr
            form(action="/upload/document" method="POST" enctype="multipart/form-data")
              .mb-3
                input#documentInput(type="file" name="documentFile" accept=".pdf, .docx" class="d-none")
                .input-group
                  button.btn.btn-outline-secondary(type="button", onclick="document.getElementById('documentInput').click()")
                    i.fas.fa-file-upload.me-2
                    | Chọn tài liệu...
                  span#fileNameDocument.form-control.text-muted Chưa có file nào được chọn
              button.btn.btn-primary.w-100.mt-3(type="submit") Tải lên

  //- SCRIPT XEM TRƯỚC FILE
  script.
    // Avatar preview
    const avatarInput = document.getElementById('avatarInput');
    const avatarPreview = document.getElementById('avatarPreview');
    const fileNameAvatar = document.getElementById('fileNameAvatar');

    avatarInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        avatarPreview.src = URL.createObjectURL(file);
        fileNameAvatar.textContent = `Đã chọn: ${file.name}`;
        fileNameAvatar.classList.remove('text-muted');
        fileNameAvatar.classList.add('text-success');
      } else {
        fileNameAvatar.textContent = 'Chưa có file nào được chọn.';
        fileNameAvatar.classList.add('text-muted');
        fileNameAvatar.classList.remove('text-success');
      }
    });

    // Document preview
    const documentInput = document.getElementById('documentInput');
    const fileNameDocument = document.getElementById('fileNameDocument');

    documentInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        fileNameDocument.textContent = `Đã chọn: ${file.name}`;
        fileNameDocument.classList.remove('text-muted');
        fileNameDocument.classList.add('text-success');
      } else {
        fileNameDocument.textContent = 'Chưa có file nào được chọn.';
        fileNameDocument.classList.add('text-muted');
        fileNameDocument.classList.remove('text-success');
      }
    });
