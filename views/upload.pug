extends ../views/layouts/default.pug

block main
  .container.mt-4.upload-container
    .row.justify-content-center
      .col-lg-10
        .card.upload-card
          .card-body
            h2.card-title.text-center.mb-3 
              i.fas.fa-file-upload.text-primary.me-2
              | Tải lên tài liệu để tóm tắt
            p.text-center.text-muted.mb-4 
              | Chọn file PDF, DOCX, hoặc TXT. AI sẽ đọc và tóm tắt nội dung cho bạn.
              br
              small.text-warning
                i.fas.fa-info-circle.me-1
                | Tối đa 50MB

            form#uploadForm
              .mb-4
                .file-upload-area.border.rounded-3.p-4.text-center
                  i.fas.fa-cloud-upload-alt.display-4.text-muted.mb-3
                  
                  label.form-label.fw-bold.fs-5(for="documentFile") 
                    | Chọn hoặc kéo thả file vào đây
                  
                  input.form-control.d-none(type="file" name="documentFile" id="documentFile" accept=".pdf,.docx,.txt")
                  
                  .mt-2
                    small.text-muted PDF, DOCX, TXT (Tối đa 50MB)
                  
                  #fileInfo.mt-2

              .d-grid
                button#submitBtn.btn.btn-primary.btn-lg.py-3(type="submit")
                  i.fas.fa-robot.me-2
                  | Bắt đầu phân tích tài liệu

            //- Khu vực hiển thị tiến trình
            #progressArea.mt-4(style="display:none;")
              .processing-indicator.text-center.mb-3
                i.fas.fa-cog.fa-spin.fa-2x.text-primary
              .d-flex.justify-content-between.align-items-center.mb-2
                p#progressStatus.mb-0.fw-semibold Đang khởi tạo...
                span#progressText.badge.bg-primary.fs-6 0%
              .progress(role="progressbar" aria-label="Tiến trình xử lý" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="height: 12px;")
                .progress-bar.progress-bar-striped.progress-bar-animated#progressBar(style="width: 0%")

            //- Khu vực hiển thị lỗi
            #errorArea.alert.alert-danger.mt-3(style="display:none;")
              i.fas.fa-exclamation-triangle.me-2
              span#errorMessage

        //- Khu vực hiển thị kết quả
        .card.mt-4.upload-card#resultArea(style="display:none;")
          .card-header.bg-success.text-white.d-flex.align-items-center
            i.fas.fa-check-circle.me-2
            h4.mb-0.flex-grow-1 ✅ Phân tích hoàn tất!
            span.badge.bg-light.text-success.fs-6
              i.fas.fa-clock.me-1
              | Thành công
          
          .card-body
            .text-center.mb-4
              i.fas.fa-project-diagram.fa-3x.text-success.mb-3
              p.card-text.fs-5 
                | Tài liệu đã được phân tích thành công! 
                br
                | Bạn có muốn lưu và tạo Mindmap từ nội dung này không?
            
            .d-grid.gap-3.d-md-flex.justify-content-md-center.mb-4
              button.btn.btn-success.btn-lg.px-4.py-3#createMindmapBtn
                i.fas.fa-save.me-2
                | Lưu và Tạo Mindmap
              button.btn.btn-outline-primary.btn-lg.px-4.py-3#viewJsonBtn(type="button")
                i.fas.fa-code.me-2
                | Xem dữ liệu Markdown
              button.btn.btn-outline-secondary.btn-lg.px-4.py-3#newUploadBtn(type="button")
                i.fas.fa-plus.me-2
                | Tải file mới

            //- Khu vực xem trước
            #jsonPreview.mt-4(style="display: none;")
              .d-flex.justify-content-between.align-items-center.mb-3
                h5.mb-0
                  i.fas.fa-file-alt.me-2
                  | Nội dung Markdown
                .btn-group
                  button.btn.btn-sm.btn-outline-success#copyJsonBtn
                    i.fas.fa-copy.me-1
                    | Sao chép
                  button.btn.btn-sm.btn-outline-info#downloadJsonBtn
                    i.fas.fa-download.me-1
                    | Tải xuống
              
              .card.border-0
                .card-body.p-0
                  pre#mindmapPreview.bg-light.text-dark.p-4.rounded-3(style="max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-break: break-all;")

        // === DEBUG MODE: Hiển thị rawText khi DEBUG_RAW=true ===
        #rawTextSection.mt-4.hidden
          h5.text-primary.mb-2
            i.fas.fa-bug.me-2
            | Raw AI Output (DEBUG)
          pre#rawTextArea.bg-dark.text-success.p-3.rounded(style="max-height: 300px; overflow-y: auto; white-space: pre-wrap; font-size: 0.85rem;")

block scripts
  script.
    const uploadForm = document.getElementById('uploadForm');
    const documentInput = document.getElementById('documentFile');
    const fileInfo = document.getElementById('fileInfo');
    const submitBtn = document.getElementById('submitBtn');
    const progressArea = document.getElementById('progressArea');
    const progressStatus = document.getElementById('progressStatus');
    const progressText = document.getElementById('progressText');
    const progressBar = document.getElementById('progressBar');
    const resultArea = document.getElementById('resultArea');
    const errorArea = document.getElementById('errorArea');
    const errorMessage = document.getElementById('errorMessage');
    const createMindmapBtn = document.getElementById('createMindmapBtn');
    const viewJsonBtn = document.getElementById('viewJsonBtn');
    const newUploadBtn = document.getElementById('newUploadBtn');
    const jsonPreview = document.getElementById('jsonPreview');
    const mindmapPreview = document.getElementById('mindmapPreview');
    const copyJsonBtn = document.getElementById('copyJsonBtn');
    const downloadJsonBtn = document.getElementById('downloadJsonBtn');
    const fileUploadArea = document.querySelector('.file-upload-area');

    // === DEBUG ELEMENTS ===
    const rawTextSection = document.getElementById('rawTextSection');
    const rawTextArea = document.getElementById('rawTextArea');

    let mindmapData = null;
    let eventSource = null;
    let isProcessing = false;
    let currentFile = null;

    fileUploadArea.addEventListener('click', () => documentInput.click());
    fileUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); fileUploadArea.classList.add('border-primary', 'bg-light'); });
    fileUploadArea.addEventListener('dragleave', () => { fileUploadArea.classList.remove('border-primary', 'bg-light'); });
    fileUploadArea.addEventListener('drop', (e) => { e.preventDefault(); fileUploadArea.classList.remove('border-primary', 'bg-light'); if (e.dataTransfer.files.length > 0) handleFileSelection(e.dataTransfer.files[0]); });
    documentInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFileSelection(e.target.files[0]); });

    function handleFileSelection(file) {
      currentFile = file;
      const fileSize = (file.size / (1024 * 1024)).toFixed(2);
      if (fileSize > 50) { showError('File quá lớn! Vui lòng chọn file nhỏ hơn 50MB.'); resetFileSelection(); return; }
      fileInfo.innerHTML = `<div class="alert alert-success py-2"><i class="fas fa-file me-2"></i><strong>${file.name}</strong> (${fileSize} MB)<button type="button" class="btn-close btn-sm float-end" onclick="resetFileSelection()"></button></div>`;
      fileUploadArea.classList.add('border-success');
      submitBtn.disabled = false;
    }

    function resetFileSelection() {
      documentInput.value = ''; fileInfo.innerHTML = ''; fileUploadArea.classList.remove('border-success'); currentFile = null; submitBtn.disabled = true;
    }

    uploadForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (isProcessing) { showError('Đang xử lý file trước đó. Vui lòng đợi...'); return; }
      if (!currentFile) { showError('Vui lòng chọn một file.'); return; }

      isProcessing = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang tải lên...';
      submitBtn.disabled = true;
      progressArea.style.display = 'block';
      updateProgressBar(0, '0%');
      progressStatus.textContent = 'Đang khởi tạo...';
      resultArea.style.display = 'none';
      jsonPreview.style.display = 'none';
      errorArea.style.display = 'none';
      mindmapData = null;
      if (eventSource) eventSource.close();

      // RESET DEBUG UI
      rawTextSection.classList.add('hidden');
      rawTextArea.textContent = '';

      const formData = new FormData();
      formData.append('documentFile', currentFile);

      try {
        const startResponse = await fetch('/upload/start-summarize', { method: 'POST', body: formData });
        if (!startResponse.ok) { let errorData = await startResponse.json(); throw new Error(errorData.error || 'Lỗi server'); }
        const { jobId } = await startResponse.json();

        eventSource = new EventSource(`/upload/summarize-stream?jobId=${encodeURIComponent(jobId)}`);
        eventSource.onopen = () => { progressStatus.textContent = 'Đã kết nối, đang xử lý tài liệu...'; };

        eventSource.addEventListener('progress', (event) => {
          const data = JSON.parse(event.data);
          if (data.type === 'chunk_complete') {
            const percent = Math.round((data.currentChunk / data.totalChunks) * 100);
            updateProgressBar(percent, `${percent}%`);
            progressStatus.textContent = `Đang xử lý phần ${data.currentChunk}/${data.totalChunks}...`;
          } else if (data.message) {
            progressStatus.textContent = data.message;
          }
        });

        // === NHẬN RAW DEBUG DATA ===
        eventSource.addEventListener('debug_raw', (event) => {
          rawTextSection.classList.remove('hidden');
          const data = JSON.parse(event.data);
          rawTextArea.textContent += `\n\n[Chunk ${data.chunk}] ${data.rawText}`;
          rawTextArea.scrollTop = rawTextArea.scrollHeight;
        });

        eventSource.addEventListener('complete', (event) => {
          try {
            mindmapData = event.data;
            progressStatus.textContent = 'Hoàn thành!';
            updateProgressBar(100, '100%');
            setTimeout(() => {
              progressArea.style.display = 'none';
              resultArea.style.display = 'block';
              mindmapPreview.textContent = mindmapData;
              isProcessing = false;
              resetSubmitButton();
              resultArea.scrollIntoView({ behavior: 'smooth' });
            }, 800);
          } catch (e) { showError('Lỗi xử lý dữ liệu kết quả từ server.'); }
          if (eventSource) eventSource.close();
        });

        eventSource.addEventListener('error_event', (event) => {
          const errorData = JSON.parse(event.data);
          showError(`Lỗi xử lý: ${errorData.message || 'Lỗi không xác định'}`);
        });

        eventSource.onerror = () => { if (!mindmapData) showError('Mất kết nối với server.'); resetProcessingState(); };

      } catch (error) { showError('Lỗi: ' + error.message); resetProcessingState(); }
    });

    viewJsonBtn.addEventListener('click', () => { jsonPreview.style.display = jsonPreview.style.display === 'none' ? 'block' : 'none'; });
    newUploadBtn.addEventListener('click', () => { resetFileSelection(); resultArea.style.display = 'none'; jsonPreview.style.display = 'none'; progressArea.style.display = 'none'; errorArea.style.display = 'none'; mindmapData = null; });
    
    copyJsonBtn.addEventListener('click', async () => {
      if (mindmapData) { await navigator.clipboard.writeText(mindmapData); copyJsonBtn.innerHTML = '<i class="fas fa-check me-1"></i>Đã sao chép!'; setTimeout(() => { copyJsonBtn.innerHTML = '<i class="fas fa-copy me-1"></i>Sao chép'; }, 2000); }
    });

    downloadJsonBtn.addEventListener('click', () => {
      if (mindmapData) { const blob = new Blob([mindmapData], { type: 'text/markdown' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `mindmap-${Date.now()}.md`; a.click(); URL.revokeObjectURL(url); }
    });

    createMindmapBtn.addEventListener('click', async () => {
      if (!mindmapData) { return alert('Không có dữ liệu để lưu.'); }
      createMindmapBtn.disabled = true; createMindmapBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang lưu...';
      
      let title = 'Mindmap không có tiêu đề';
      const firstLine = mindmapData.split('\n')[0];
      if (firstLine && firstLine.startsWith('#')) { title = firstLine.replace(/#+\s*/, '').trim(); }

      try {
        const response = await fetch('/mindmaps/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCSRFToken() },
          body: JSON.stringify({ title: title, content: mindmapData }),
        });
        if (!response.ok) { const err = await response.json(); throw new Error(err.error || 'Lỗi server'); }
        window.location.href = '/dashboard';
      } catch (error) {
        alert('Lỗi khi lưu Mindmap:\n' + error.message);
        createMindmapBtn.disabled = false; createMindmapBtn.innerHTML = '<i class="fas fa-save me-2"></i>Lưu và Tạo Mindmap';
      }
    });

    function showError(message) { errorMessage.textContent = message; errorArea.style.display = 'block'; progressArea.style.display = 'none'; resetProcessingState(); }
    function resetSubmitButton() { submitBtn.innerHTML = '<i class="fas fa-robot me-2"></i>Bắt đầu phân tích tài liệu'; submitBtn.disabled = !currentFile; }
    function resetProcessingState() { isProcessing = false; resetSubmitButton(); if (eventSource) { eventSource.close(); eventSource = null; } }
    function updateProgressBar(value, text) { progressBar.style.width = `${value}%`; progressBar.setAttribute('aria-valuenow', value); progressText.textContent = text; }
    function getCSRFToken() { return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''; }
    window.addEventListener('beforeunload', () => { if (eventSource) eventSource.close(); });
    submitBtn.disabled = true;
