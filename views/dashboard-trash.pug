extends ../views/layouts/default.pug

block styles
  link(rel="stylesheet", href="/css/style-dashboard.css")
  //- CSS cho các nút mới (tùy chọn)
    

block main
  .dashboard-layout
    //- Sidebar (KHÔNG CÓ [cite: 2] ở đây)
    aside.dashboard-sidebar
      nav.sidebar-nav
        ul
          li
            a(href="/dashboard", title="Danh sách Mindmap")
              i.bi.bi-list-task
              span Danh sách
          
          li
            a(href="/dashboard/folder" title="Thư mục")
              i.fas.fa-folder-open
              span Thư mục
        
          li
            a.active(href="/dashboard/trash", title="Thùng rác")
              i.fas.fa-trash
              span Thùng rác

    main.dashboard-content
      //- SỬ DỤNG LOGIC IF/ELSE
      if mindmaps && mindmaps.length > 0
        //- Nếu có mindmap
        
        //- Bọc tiêu đề và nút "Dọn rác"
        .content-header-trash
          h2.content-title-trash Thùng rác
          //- Nút Dọn sạch thùng rác
          button#btn-empty-trash(type="button")
            i.fas.fa-fire.me-2
            | Dọn sạch thùng rác

        #trashGrid.mindmap-grid
          each mindmap in mindmaps
            .mindmap-card(data-id=`${mindmap._id}`)
              .preview-image
              .card-title #{mindmap.title}

              //- KHỐI HIỂN THỊ SỐ NGÀY CÒN LẠI
              .card-footer
                i.fas.fa-clock.me-2
                small.text-muted Xóa vĩnh viễn sau #{mindmap.remainingDays} ngày
                
              //- Khối chứa nút hành động
              .trash-card-actions
                //- Nút Khôi phục
                button.btn-action.btn-recover(type="button", title="Khôi phục"): i.fas.fa-undo-alt
                //- Nút Xóa vĩnh viễn
                button.btn-action.btn-delete-permanent-trash(type="button", title="Xóa vĩnh viễn"): i.fas.fa-trash-alt

      else
        //- Nếu không có mindmap (giữ nguyên)
        .empty-trash-container
          i.fas.fa-trash-alt.empty-icon
          h4.empty-title Mọi mindmap bạn xóa sẽ nằm ở đây
          p.empty-text Bạn có 30 ngày để khôi phục trước khi chúng tự động bị xóa khỏi Thùng rác.

//- SCRIPT ĐÃ ĐƯỢC CẬP NHẬT
block scripts
  script.
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {

        // === MODAL XÁC NHẬN XÓA ===
        function showConfirmModal(title, message, confirmText = 'Xác nhận') {
          const modal = document.getElementById('confirmModal');
          document.getElementById('modalTitle').textContent = title;
          document.getElementById('modalMessage').textContent = message;
          modal.classList.add('show');

          const deleteBtn = document.getElementById('confirmDeleteBtn');
          deleteBtn.textContent = confirmText;

          return new Promise((resolve) => {
            const cancelBtn = document.getElementById('confirmCancelBtn');

            cancelBtn.addEventListener('click', () => {
              modal.classList.remove('show');
              resolve(false);
            }, { once: true });

            deleteBtn.addEventListener('click', () => {
              modal.classList.remove('show');
              resolve(true);
            }, { once: true });
          });
        }

        const trashGrid = document.getElementById('trashGrid');

        // === DỌN SẠCH THÙNG RÁC ===
        const emptyTrashButton = document.getElementById('btn-empty-trash');
        if (emptyTrashButton) {
          emptyTrashButton.addEventListener('click', async () => {
            const userConfirmed = await showConfirmModal(
              'Dọn sạch thùng rác?',
              'Tất cả mindmap sẽ bị xóa vĩnh viễn và không thể khôi phục.',
              'Dọn sạch thùng rác' // <-- NỘI DUNG NÚT ĐỎ MỚI
            );
            if (userConfirmed) {
              fetch('/dashboard/trash/empty', { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                  if (data.success) {
                    window.location.reload();
                  } else {
                    showToast('Lỗi: ' + data.message, 'Lỗi', 'error');
                  }
                })
                .catch(() => showToast('Lỗi kết nối khi dọn rác.', 'Lỗi', 'error'));
            }
          });
        }

        // === CLICK TRÊN LƯỚI ===
        if (trashGrid) {
          trashGrid.addEventListener('click', async (event) => {
            const recoverButton = event.target.closest('.btn-recover');
            const deleteButton = event.target.closest('.btn-delete-permanent-trash');
            const mindmapCard = event.target.closest('.mindmap-card');
            if (!mindmapCard) return;
            const mindmapId = mindmapCard.dataset.id;

            // --- KHÔI PHỤC ---
            if (recoverButton) {
              fetch(`/dashboard/trash/recover/${mindmapId}`, { method: 'PATCH' })
                .then(res => res.json())
                .then(data => {
                  if (data.success) {
                    mindmapCard.remove();
                    showToast('Đã khôi phục! Đang quay về Dashboard...', 'Thành công', 'success');
                    setTimeout(() => {
                      window.location.href = '/dashboard';
                    }, 2000);
                  } else {
                    showToast('Lỗi: ' + data.message, 'Lỗi', 'error');
                  }
                })
                .catch(() => showToast('Lỗi kết nối khi khôi phục.', 'Lỗi', 'error'));
            }

            // --- XÓA VĨNH VIỄN ---
            else if (deleteButton) {
              const userConfirmed = await showConfirmModal(
                'Xóa vĩnh viễn mindmap?',
                'Hành động này không thể hoàn tác. Mindmap sẽ bị xóa vĩnh viễn.',
                'Xóa vĩnh viễn'
              );
              if (userConfirmed) {
                fetch(`/dashboard/trash/delete/${mindmapId}`, { method: 'DELETE' })
                  .then(res => res.json())
                  .then(data => {
                    if (data.success) {
                      mindmapCard.remove();
                      if (trashGrid.children.length === 0) {
                        window.location.reload();
                      }
                      showToast('Đã xóa mindmap vĩnh viễn!', 'Thành công', 'success');
                    } else {
                      showToast('Lỗi: ' + data.message, 'Lỗi', 'error');
                    }
                  })
                  .catch(() => showToast('Lỗi kết nối khi xóa.', 'Lỗi', 'error'));
              }
            }
          });
        }
      }, 0);
    });