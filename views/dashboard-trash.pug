extends ../views/layouts/default.pug

block styles
  link(rel="stylesheet", href="/css/style-dashboard.css")
  //- CSS cho các nút mới (tùy chọn)
    

block main
  .dashboard-layout
    //- Sidebar (KHÔNG CÓ [cite: 2] ở đây)
    aside.dashboard-sidebar
      nav.sidebar-nav
        ul
          li
            a(href="/dashboard", title="Danh sách Mindmap")
              i.fas.fa-folder-open
              span Danh sách
          li
            a.active(href="/dashboard/trash", title="Thùng rác")
              i.fas.fa-trash
              span Thùng rác

    main.dashboard-content
      //- SỬ DỤNG LOGIC IF/ELSE
      if mindmaps && mindmaps.length > 0
        //- Nếu có mindmap
        
        //- Bọc tiêu đề và nút "Dọn rác"
        .content-header-trash
          h2.content-title-trash Thùng rác
          //- Nút Dọn sạch thùng rác
          button#btn-empty-trash(type="button")
            i.fas.fa-fire.me-2
            | Dọn sạch thùng rác

        #trashGrid.mindmap-grid
          each mindmap in mindmaps
            .mindmap-card(data-id=`${mindmap._id}`)
              .preview-image
              .card-title #{mindmap.title}

              //- KHỐI HIỂN THỊ SỐ NGÀY CÒN LẠI
              .card-footer
                i.fas.fa-clock.me-2
                small.text-muted Xóa vĩnh viễn sau #{mindmap.remainingDays} ngày
                
              //- Khối chứa nút hành động
              .trash-card-actions
                //- Nút Khôi phục
                button.btn-action.btn-recover(type="button", title="Khôi phục")
                  i.fas.fa-undo-alt
                //- Nút Xóa vĩnh viễn
                button.btn-action.btn-delete-permanent-trash(type="button", title="Xóa vĩnh viễn")
                  i.fas.fa-trash-alt

      else
        //- Nếu không có mindmap (giữ nguyên)
        .empty-trash-container
          i.fas.fa-trash-alt.empty-icon
          h4.empty-title Mọi mindmap bạn xóa sẽ nằm ở đây
          p.empty-text Bạn có 30 ngày để khôi phục trước khi chúng tự động bị xóa khỏi Thùng rác.

//- SCRIPT ĐÃ ĐƯỢC CẬP NHẬT
block scripts
  script.
    document.addEventListener('DOMContentLoaded', () => {

      const trashGrid = document.getElementById('trashGrid');

      //--- Xử lý nút DỌN SẠCH THÙNG RÁC ---
      const emptyTrashButton = document.getElementById('btn-empty-trash');
      if (emptyTrashButton) {
        emptyTrashButton.addEventListener('click', () => {
          if (confirm('Bạn có chắc muốn DỌN SẠCH thùng rác? Tất cả mindmap sẽ bị xóa vĩnh viễn và không thể khôi phục.')) {
            fetch('/dashboard/trash/empty', {
              method: 'DELETE'
            })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                // Tải lại trang để hiển thị giao diện thùng rác trống
                window.location.reload(); 
              } else {
                alert('Lỗi: ' + data.message);
              }
            })
            .catch(err => alert('Lỗi kết nối khi dọn rác.'));
          }
        });
      }

      //--- Xử lý sự kiện click trên lưới (cho cả 2 nút) ---
      if (!trashGrid) return; 

      trashGrid.addEventListener('click', (event) => {
        const recoverButton = event.target.closest('.btn-recover');
        const deleteButton = event.target.closest('.btn-delete-permanent-trash'); // Nút Xóa

        const mindmapCard = event.target.closest('.mindmap-card');
        if (!mindmapCard) return; // Thoát nếu không click vào thẻ nào

        const mindmapId = mindmapCard.dataset.id;

        // Xử lý nút KHÔI PHỤC
        if (recoverButton) {
          fetch(`/dashboard/trash/recover/${mindmapId}`, { method: 'PATCH' })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                // Xóa thẻ khỏi giao diện và chuyển hướng
                mindmapCard.remove();
                alert('Đã khôi phục thành công! Quay về Dashboard.');
                window.location.href = '/dashboard';
              } else {
                alert('Lỗi: ' + data.message);
              }   
            })
            .catch(err => alert('Lỗi kết nối khi khôi phục.'));
        } 
        
        // Xử lý nút XÓA VĨNH VIỄN
        else if (deleteButton) {
          if (confirm('Bạn có chắc muốn XÓA VĨNH VIỄN mindmap này? Hành động này không thể hoàn tác.')) {
            fetch(`/dashboard/trash/delete/${mindmapId}`, { 
              method: 'DELETE' 
            })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                // Xóa thẻ khỏi giao diện
                mindmapCard.remove();
                // Kiểm tra xem còn thẻ nào không, nếu không thì tải lại trang
                if (trashGrid.children.length === 0) {
                  window.location.reload();
                }
              } else {
                alert('Lỗi: ' + data.message);
              }
            })
            .catch(err => alert('Lỗi kết nối khi xóa.'));
          }
        }
      });
    });