extends ../views/layouts/default.pug
block styles
  link(rel="stylesheet", href="/css/style-profile-edit.css")
block main
  //- Sá»­ dá»¥ng container-fluid Ä‘á»ƒ khá»‘i ná»™i dung rá»™ng ra
  .container-fluid.px-md-5.mt-5
    //- Thay tháº¿ .row báº±ng class .profile-edit-grid cá»§a riÃªng mÃ¬nh
    .profile-edit-grid

      //- Card 1: Chá»‰nh sá»­a thÃ´ng tin
      .profile-edit-card
        .card
          .card-header
            h4 Chá»‰nh sá»­a thÃ´ng tin
          .card-body
            //- Form vÃ  cÃ¡c ná»™i dung bÃªn trong giá»¯ nguyÃªn
            form#editProfileForm
              .mb-3
                label.form-label(for="editName") Há» vÃ  tÃªn
                input#editName.form-control(type="text", value=user.name || '')
              .mb-3
                label.form-label(for="editUsername") TÃªn ngÆ°á»i dÃ¹ng
                input#editUsername.form-control(type="text", value=user.username || '')
              .mb-3
                label.form-label(for="editEmail") Email
                input#editEmail.form-control(type="email", value=user.email || '', readonly)
                small.form-text.text-muted Email khÃ´ng thá»ƒ thay Ä‘á»•i.
              .d-flex.justify-content-end
                a.btn.btn-secondary.me-2(href="/profile") Há»§y
                button.btn.btn-primary(type="submit") LÆ°u thay Ä‘á»•i
              hr.my-4
              h4.mb-3 Äá»•i máº­t kháº©u
              .form-group
                .mb-3
                  label.form-label(for="newPassword") Máº­t kháº©u má»›i
                  input#newPassword.form-control(type="password" required)
                
                .mb-3
                  label.form-label(for="confirmPassword") XÃ¡c nháº­n máº­t kháº©u má»›i
                  input#confirmPassword.form-control(type="password" required)
                
                .d-flex.justify-content-end
                  button#changePasswordBtn.btn.btn-danger(type="button") Äá»•i máº­t kháº©u

              script.
                document.getElementById('changePasswordBtn').addEventListener('click', async function() {
                  const password = document.getElementById('newPassword').value;
                  const confirmPassword = document.getElementById('confirmPassword').value;
                  
                  console.log("ðŸŽ¯ Báº®T Äáº¦U Äá»”I Máº¬T KHáº¨U");
                  console.log("Máº­t kháº©u:", password);
                  console.log("XÃ¡c nháº­n:", confirmPassword);
                  
                  if (!password || !confirmPassword) {
                    alert('Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ máº­t kháº©u!');
                    return;
                  }
                  
                  if (password !== confirmPassword) {
                    alert('Máº­t kháº©u xÃ¡c nháº­n khÃ´ng khá»›p!');
                    return;
                  }
                  
                  try {
                    const response = await fetch('/profile/change-password', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                        password: password,
                        confirmPassword: confirmPassword
                      })
                    });
                    
                    console.log("ðŸ“¨ Response status:", response.status);
                    
                    // Chuyá»ƒn hÆ°á»›ng
                    window.location.href = '/profile';
                    
                  } catch (error) {
                    console.error('âŒ Lá»—i:', error);
                    alert('CÃ³ lá»—i xáº£y ra!');
                  }
                });
      //- Card 2: Cáº­p nháº­t áº£nh Ä‘áº¡i diá»‡n
      .profile-edit-card
        .card
          .card-header
            h4 Cáº­p nháº­t áº£nh Ä‘áº¡i diá»‡n
          .card-body
            form(action="/profile/avatar" method="POST" enctype="multipart/form-data")
              input#avatarInput(type="file" name="avatar" accept="image/*" class="d-none" required)
              button.btn.btn-outline-secondary.mb-3(type="button", onclick="document.getElementById('avatarInput').click()")
                i.fas.fa-upload.me-2
                | Chá»n áº£nh má»›i
              span#fileNameAvatar.text-muted.mb-3 ChÆ°a cÃ³ file nÃ o Ä‘Æ°á»£c chá»n

             
              #previewContainer.mb-3(style="position: relative; display: none;")
                img#avatarPreview.rounded-circle.shadow(style="width:150px;height:150px;object-fit:cover;border:3px solid #ddd;")
                //- NÃºt xÃ³a (dáº¥u 'x')
                button#btnClosePreview.btn-close-preview(type="button") &times;

              button.btn.btn-primary(type="submit")
                i.fas.fa-save.me-2
                | LÆ°u áº£nh Ä‘áº¡i diá»‡n
  
  script.
    document.getElementById('editProfileForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('editName').value.trim();
      const username = document.getElementById('editUsername').value.trim();
      const userId = "#{user._id}";

      try {
        const res = await fetch('/profile/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, name, username })
        });
        const data = await res.json();
        if (data.success) {
          window.location.href = '/profile';
        } else {
          alert('âŒ ' + (data.message || 'CÃ³ lá»—i xáº£y ra.'));
        }
      } catch (err) {
        alert('âš ï¸ Lá»—i khi gá»­i dá»¯ liá»‡u: ' + err.message);
      }
    });


  //- Script cho preview áº£nh
  script.
    document.getElementById('avatarInput')?.addEventListener('change', e => {
      const file = e.target.files[0];
      const fileNameAvatar = document.getElementById('fileNameAvatar');
      const avatarPreview = document.getElementById('avatarPreview');
      if (file) {
        fileNameAvatar.textContent = file.name;
        const reader = new FileReader();
        reader.onload = e => {
          avatarPreview.src = e.target.result;
          avatarPreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });

  script.
    // Láº¥y ra táº¥t cáº£ cÃ¡c pháº§n tá»­ cáº§n thiáº¿t
    const avatarInput = document.getElementById('avatarInput');
    const fileNameAvatar = document.getElementById('fileNameAvatar');
    const previewContainer = document.getElementById('previewContainer');
    const avatarPreview = document.getElementById('avatarPreview');
    const btnClosePreview = document.getElementById('btnClosePreview');

    // HÃ m Ä‘á»ƒ reset láº¡i form upload
    function resetAvatarUpload() {
      avatarInput.value = ''; // XÃ³a file Ä‘Ã£ chá»n
      fileNameAvatar.textContent = 'ChÆ°a cÃ³ file nÃ o Ä‘Æ°á»£c chá»n';
      previewContainer.style.display = 'none'; // áº¨n áº£nh preview vÃ  nÃºt xÃ³a
    }

    // Sá»± kiá»‡n khi ngÆ°á»i dÃ¹ng chá»n má»™t file áº£nh má»›i
    avatarInput?.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        fileNameAvatar.textContent = file.name;
        const reader = new FileReader();
        reader.onload = e => {
          avatarPreview.src = e.target.result;
          previewContainer.style.display = 'block'; // Hiá»ƒn thá»‹ cáº£ khá»‘i preview
        };
        reader.readAsDataURL(file);
      }
    });

    // Sá»± kiá»‡n khi ngÆ°á»i dÃ¹ng nháº¥p vÃ o nÃºt xÃ³a
    btnClosePreview?.addEventListener('click', () => {
      resetAvatarUpload();
    });