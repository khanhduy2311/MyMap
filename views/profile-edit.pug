extends ../views/layouts/default.pug
block styles
  link(rel="stylesheet", href="/css/style-profile-edit.css")
block main
  //- Sử dụng container-fluid để khối nội dung rộng ra
  .container-fluid.px-md-5.mt-5
    //- Thay thế .row bằng class .profile-edit-grid của riêng mình
    .profile-edit-grid

      //- Card 1: Chỉnh sửa thông tin
      .profile-edit-card
        .card
          .card-header
            h4 Chỉnh sửa thông tin
          .card-body
            //- Form và các nội dung bên trong giữ nguyên
            form#editProfileForm
              .mb-3
                label.form-label(for="editName") Họ và tên
                input#editName.form-control(type="text", value=user.name || '')
              .mb-3
                label.form-label(for="editUsername") Tên người dùng
                input#editUsername.form-control(type="text", value=user.username || '')
              .mb-3
                label.form-label(for="editEmail") Email
                input#editEmail.form-control(type="email", value=user.email || '', readonly)
                small.form-text.text-muted Email không thể thay đổi.
              .d-flex.justify-content-end
                a.btn.btn-secondary.me-2(href="/profile") Hủy
                button.btn.btn-primary(type="submit") Lưu thay đổi
              hr.my-4
              h4.mb-3 Đổi mật khẩu
              .form-group
                .mb-3
                  label.form-label(for="newPassword") Mật khẩu mới
                  input#newPassword.form-control(type="password" required)
                
                .mb-3
                  label.form-label(for="confirmPassword") Xác nhận mật khẩu mới
                  input#confirmPassword.form-control(type="password" required)
                
                .d-flex.justify-content-end
                  button#changePasswordBtn.btn.btn-danger(type="button") Đổi mật khẩu

              script.
                document.getElementById('changePasswordBtn').addEventListener('click', async function() {
                  const password = document.getElementById('newPassword').value;
                  const confirmPassword = document.getElementById('confirmPassword').value;
                  
                  console.log("🎯 BẮT ĐẦU ĐỔI MẬT KHẨU");
                  console.log("Mật khẩu:", password);
                  console.log("Xác nhận:", confirmPassword);
                  
                  if (!password || !confirmPassword) {
                    alert('Vui lòng nhập đầy đủ mật khẩu!');
                    return;
                  }
                  
                  if (password !== confirmPassword) {
                    alert('Mật khẩu xác nhận không khớp!');
                    return;
                  }
                  
                  try {
                    const response = await fetch('/profile/change-password', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                        password: password,
                        confirmPassword: confirmPassword
                      })
                    });
                    
                    console.log("📨 Response status:", response.status);
                    
                    // Chuyển hướng
                    window.location.href = '/profile';
                    
                  } catch (error) {
                    console.error('❌ Lỗi:', error);
                    alert('Có lỗi xảy ra!');
                  }
                });
      //- Card 2: Cập nhật ảnh đại diện
      .profile-edit-card
        .card
          .card-header
            h4 Cập nhật ảnh đại diện
          .card-body
            form(action="/profile/avatar" method="POST" enctype="multipart/form-data")
              input#avatarInput(type="file" name="avatar" accept="image/*" class="d-none" required)
              button.btn.btn-outline-secondary.mb-3(type="button", onclick="document.getElementById('avatarInput').click()")
                i.fas.fa-upload.me-2
                | Chọn ảnh mới
              span#fileNameAvatar.text-muted.mb-3 Chưa có file nào được chọn

             
              #previewContainer.mb-3(style="position: relative; display: none;")
                img#avatarPreview.rounded-circle.shadow(style="width:150px;height:150px;object-fit:cover;border:3px solid #ddd;")
                //- Nút xóa (dấu 'x')
                button#btnClosePreview.btn-close-preview(type="button") &times;

              button.btn.btn-primary(type="submit")
                i.fas.fa-save.me-2
                | Lưu ảnh đại diện
  
  script.
    document.getElementById('editProfileForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('editName').value.trim();
      const username = document.getElementById('editUsername').value.trim();
      const userId = "#{user._id}";

      try {
        const res = await fetch('/profile/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, name, username })
        });
        const data = await res.json();
        if (data.success) {
          window.location.href = '/profile';
        } else {
          alert('❌ ' + (data.message || 'Có lỗi xảy ra.'));
        }
      } catch (err) {
        alert('⚠️ Lỗi khi gửi dữ liệu: ' + err.message);
      }
    });


  //- Script cho preview ảnh
  script.
    document.getElementById('avatarInput')?.addEventListener('change', e => {
      const file = e.target.files[0];
      const fileNameAvatar = document.getElementById('fileNameAvatar');
      const avatarPreview = document.getElementById('avatarPreview');
      if (file) {
        fileNameAvatar.textContent = file.name;
        const reader = new FileReader();
        reader.onload = e => {
          avatarPreview.src = e.target.result;
          avatarPreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });

  script.
    // Lấy ra tất cả các phần tử cần thiết
    const avatarInput = document.getElementById('avatarInput');
    const fileNameAvatar = document.getElementById('fileNameAvatar');
    const previewContainer = document.getElementById('previewContainer');
    const avatarPreview = document.getElementById('avatarPreview');
    const btnClosePreview = document.getElementById('btnClosePreview');

    // Hàm để reset lại form upload
    function resetAvatarUpload() {
      avatarInput.value = ''; // Xóa file đã chọn
      fileNameAvatar.textContent = 'Chưa có file nào được chọn';
      previewContainer.style.display = 'none'; // Ẩn ảnh preview và nút xóa
    }

    // Sự kiện khi người dùng chọn một file ảnh mới
    avatarInput?.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        fileNameAvatar.textContent = file.name;
        const reader = new FileReader();
        reader.onload = e => {
          avatarPreview.src = e.target.result;
          previewContainer.style.display = 'block'; // Hiển thị cả khối preview
        };
        reader.readAsDataURL(file);
      }
    });

    // Sự kiện khi người dùng nhấp vào nút xóa
    btnClosePreview?.addEventListener('click', () => {
      resetAvatarUpload();
    });