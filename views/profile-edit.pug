extends ../views/layouts/default.pug
block main
  .container.mt-5
    .row.justify-content-center
      .col-md-6
        .card
          .card-header
            h4 Chỉnh sửa thông tin
          .card-body
            form#editProfileForm
              .mb-3
                label.form-label(for="editName") Họ và tên
                input#editName.form-control(type="text", value=user.name || '')
              .mb-3
                label.form-label(for="editUsername") Tên người dùng
                input#editUsername.form-control(type="text", value=user.username || '')
              .mb-3
                label.form-label(for="editEmail") Email
                input#editEmail.form-control(type="email", value=user.email || '', readonly)
                small.form-text.text-muted Email không thể thay đổi.
              .d-flex.justify-content-end
                a.btn.btn-secondary.me-2(href="/profile") Hủy
                button.btn.btn-primary(type="submit") Lưu thay đổi

        //- Cột đổi avatar
      .col-md-6.mb-4
        .card.h-100
          .card-header
            h4 Cập nhật ảnh đại diện
          .card-body.text-center
            form(action="/profile/avatar" method="POST" enctype="multipart/form-data" class="d-flex flex-column align-items-center")
              input#avatarInput(type="file" name="avatar" accept="image/*" class="d-none" required)
              button.btn.btn-outline-secondary.mb-3(type="button", onclick="document.getElementById('avatarInput').click()")
                i.fas.fa-upload.me-2
                | Chọn ảnh mới
              span#fileNameAvatar.text-muted.mb-3 Chưa có file nào được chọn
              img#avatarPreview.rounded-circle.shadow(style="width:150px;height:150px;object-fit:cover;display:none;border:3px solid #ddd;")
              button.btn.btn-primary.mt-4(type="submit")
                i.fas.fa-save.me-2
                | Lưu ảnh đại diện
  
  
  script.
    document.getElementById('editProfileForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('editName').value.trim();
      const username = document.getElementById('editUsername').value.trim();
      const userId = "#{user._id}";

      try {
        const res = await fetch('/profile/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, name, username })
        });
        const data = await res.json();
        if (data.success) {
          alert('✅ Cập nhật thành công!');
          window.location.href = '/profile';
        } else {
          alert('❌ ' + (data.message || 'Có lỗi xảy ra.'));
        }
      } catch (err) {
        alert('⚠️ Lỗi khi gửi dữ liệu: ' + err.message);
      }
    });


  //- Script cho preview ảnh
  script.
    document.getElementById('avatarInput')?.addEventListener('change', e => {
      const file = e.target.files[0];
      const fileNameAvatar = document.getElementById('fileNameAvatar');
      const avatarPreview = document.getElementById('avatarPreview');
      if (file) {
        fileNameAvatar.textContent = file.name;
        const reader = new FileReader();
        reader.onload = e => {
          avatarPreview.src = e.target.result;
          avatarPreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });